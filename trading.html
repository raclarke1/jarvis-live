<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Performance | Jarvis</title>
    <meta http-equiv="refresh" content="300">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: linear-gradient(135deg, #1a1a2e 0%, #16162a 100%);
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --accent-green: #00ff88;
            --accent-green-dim: rgba(0,255,136,0.15);
            --accent-red: #ff4757;
            --accent-red-dim: rgba(255,71,87,0.15);
            --accent-blue: #58a6ff;
            --accent-purple: #a855f7;
            --border-color: #2a2a4a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 24px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header .subtitle { color: var(--text-secondary); margin-top: 4px; }
        .header .updated {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        /* Strategy Cards Grid */
        .strategies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        /* Strategy Card */
        .strategy-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
        }
        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .strategy-name {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .strategy-since {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .total-return {
            text-align: right;
        }
        .total-return .value {
            font-size: 2rem;
            font-weight: 700;
        }
        .total-return .value.positive { color: var(--accent-green); }
        .total-return .value.negative { color: var(--accent-red); }
        .total-return .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 12px;
        }
        .metric-card .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .metric-card .value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .metric-card .value.positive { color: var(--accent-green); }
        .metric-card .value.negative { color: var(--accent-red); }
        
        /* Mini Stats */
        .mini-stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            text-align: center;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        .mini-stat .label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .mini-stat .value {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Capital Progress */
        .capital-progress {
            display: flex;
            justify-content: space-between;
            padding-top: 16px;
            margin-top: 16px;
            border-top: 1px solid var(--border-color);
            font-size: 0.875rem;
        }
        .capital-progress .start { color: var(--text-secondary); }
        .capital-progress .arrow { color: var(--text-secondary); }
        .capital-progress .current { font-weight: 600; }
        
        /* Trade Log */
        .trade-log {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
        }
        .trade-log-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .trade-log-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .trade-log-header .count {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        /* Table */
        .trade-table {
            width: 100%;
            border-collapse: collapse;
        }
        .trade-table th {
            background: rgba(0,0,0,0.3);
            padding: 12px 16px;
            text-align: left;
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trade-table th:last-child { text-align: right; }
        .trade-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }
        .trade-table tr:hover { background: rgba(255,255,255,0.02); }
        
        /* Tags */
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        .tag.v5 { background: rgba(88,166,255,0.2); color: var(--accent-blue); }
        .tag.ibb { background: rgba(168,85,247,0.2); color: var(--accent-purple); }
        .tag.brt { background: rgba(34,197,94,0.2); color: var(--accent-green); }
        .tag.defi { background: rgba(0,255,136,0.2); color: var(--accent-green); }
        .tag.long { background: var(--accent-green-dim); color: var(--accent-green); }
        .tag.short { background: var(--accent-red-dim); color: var(--accent-red); }
        .tag.open { background: rgba(255,165,2,0.2); color: #ffa502; }
        
        /* P&L Cell */
        .pnl-cell { text-align: right; }
        .pnl-cell .usd { font-weight: 600; }
        .pnl-cell .usd.positive { color: var(--accent-green); }
        .pnl-cell .usd.negative { color: var(--accent-red); }
        .pnl-cell .pct { font-size: 0.75rem; }
        .pnl-cell .pct.positive { color: rgba(0,255,136,0.7); }
        .pnl-cell .pct.negative { color: rgba(255,71,87,0.7); }
        
        /* Asset Cell */
        .asset-cell .name { font-weight: 500; }
        .asset-cell .exchange { font-size: 0.7rem; color: var(--text-secondary); }
        
        /* Entry/Exit Cell */
        .price-cell .price { }
        .price-cell .time { font-size: 0.7rem; color: var(--text-secondary); }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px;
            color: var(--text-secondary);
        }
        
        /* Systems Status Panel */
        .systems-status {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }
        .systems-status.healthy { border-color: rgba(0,255,136,0.3); }
        .systems-status.warning { border-color: rgba(255,165,2,0.3); }
        .systems-status.error { border-color: rgba(255,71,87,0.3); }
        
        .systems-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .systems-header h2 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .systems-header .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-badge.healthy { background: var(--accent-green-dim); color: var(--accent-green); }
        .status-badge.warning { background: rgba(255,165,2,0.2); color: #ffa502; }
        .status-badge.error { background: var(--accent-red-dim); color: var(--accent-red); }
        
        .systems-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .system-check {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            font-size: 0.85rem;
        }
        .system-check .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .system-check .indicator.ok { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
        .system-check .indicator.warn { background: #ffa502; box-shadow: 0 0 8px #ffa502; }
        .system-check .indicator.error { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }
        .system-check .name { flex: 1; }
        .system-check .detail { color: var(--text-secondary); font-size: 0.75rem; }
        
        .last-executions {
            display: flex;
            gap: 24px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            font-size: 0.8rem;
        }
        .execution-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .execution-item .label { color: var(--text-secondary); }
        .execution-item .time { font-weight: 500; }
        .execution-item .time.stale { color: var(--accent-red); }
        
        /* Open Positions Panel */
        .open-positions {
            background: linear-gradient(135deg, #1a2a1a 0%, #162a16 100%);
            border: 2px solid rgba(0,255,136,0.3);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }
        .open-positions.no-positions {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }
        .open-positions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .open-positions-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .position-count {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--accent-green-dim);
            color: var(--accent-green);
        }
        .position-count.none {
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
        }
        .positions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 16px;
        }
        .position-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
        }
        .position-card.profit { border-left: 3px solid var(--accent-green); }
        .position-card.loss { border-left: 3px solid var(--accent-red); }
        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .position-asset {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .position-meta {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }
        .position-pnl {
            text-align: right;
        }
        .position-pnl .value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .position-pnl .value.positive { color: var(--accent-green); }
        .position-pnl .value.negative { color: var(--accent-red); }
        .position-pnl .pct {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .position-details {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        .position-detail .label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .position-detail .value {
            font-size: 0.9rem;
            font-weight: 500;
        }
        .position-detail .value.sl { color: var(--accent-red); }
        .position-detail .value.tp { color: var(--accent-green); }
        .no-positions-msg {
            text-align: center;
            padding: 24px;
            color: var(--text-secondary);
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 24px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .strategies-grid { grid-template-columns: 1fr; }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .mini-stats { grid-template-columns: repeat(3, 1fr); }
            .trade-table { font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Trading Performance</h1>
                <p class="subtitle">Live strategy performance and trade history</p>
            </div>
            <div class="updated" id="lastUpdated">Loading...</div>
        </div>
        
        <!-- Open Positions Panel -->
        <div class="open-positions" id="openPositions">
            <div class="open-positions-header">
                <h2>üìä Open Positions</h2>
                <span class="position-count" id="positionCount">Loading...</span>
            </div>
            <div class="positions-grid" id="positionsGrid">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <!-- Systems Status Panel -->
        <div class="systems-status" id="systemsStatus">
            <div class="systems-header">
                <h2>üêï Trading Systems Status</h2>
                <span class="status-badge" id="systemsBadge">Loading...</span>
            </div>
            <div class="systems-grid" id="systemsGrid">
                <!-- Populated by JS -->
            </div>
            <div class="last-executions" id="lastExecutions">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <!-- Strategy Cards -->
        <div class="strategies-grid" id="strategiesGrid">
            <!-- Populated by JS -->
        </div>
        
        <!-- Trade Log -->
        <div class="trade-log">
            <div class="trade-log-header">
                <h2>Trade History</h2>
                <p class="count" id="tradeCount">Loading...</p>
            </div>
            <table class="trade-table">
                <thead>
                    <tr>
                        <th>Strategy</th>
                        <th>Asset</th>
                        <th>Direction</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>Size</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="tradeTableBody">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            Updated after each trade ‚Ä¢ Kraken for spot/margin ‚Ä¢ Drift for perpetuals
        </div>
    </div>

    <script>
        // Utility functions
        function formatCurrency(value) {
            if (value === undefined || value === null || typeof value !== 'number' || isNaN(value)) return '-';
            const abs = Math.abs(value);
            const formatted = abs >= 1000 ? `$${(abs/1000).toFixed(1)}k` : `$${abs.toFixed(2)}`;
            return value < 0 ? `-${formatted}` : formatted;
        }
        
        function formatPercent(value) {
            if (value === undefined || value === null || typeof value !== 'number' || isNaN(value)) return '-';
            return `${value >= 0 ? '+' : ''}${value.toFixed(2)}%`;
        }
        
        function formatDuration(ms) {
            if (ms === undefined || ms === null || typeof ms !== 'number' || isNaN(ms)) return '-';
            const hours = ms / (1000 * 60 * 60);
            return hours < 24 ? `${hours.toFixed(1)}h` : `${(hours/24).toFixed(1)}d`;
        }
        
        function formatDate(ts) {
            const d = new Date(ts);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        function formatDateShort(ts) {
            const d = new Date(ts);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Render strategy card
        function renderStrategyCard(stats) {
            const isProfit = stats.totalPnlUsd >= 0;
            return `
                <div class="strategy-card">
                    <div class="strategy-header">
                        <div>
                            <div class="strategy-name">${stats.strategy} Strategy</div>
                            <div class="strategy-since">Since ${formatDateShort(stats.firstTradeTime)}</div>
                        </div>
                        <div class="total-return">
                            <div class="value ${isProfit ? 'positive' : 'negative'}">${formatPercent(stats.totalPnlPercent)}</div>
                            <div class="label">Total Return</div>
                        </div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="label">Total P&L</div>
                            <div class="value ${stats.totalPnlUsd >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.totalPnlUsd)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="label">Win Rate</div>
                            <div class="value ${stats.winRate >= 50 ? 'positive' : 'negative'}">${stats.winRate?.toFixed(1) ?? '-'}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="label">Profit Factor</div>
                            <div class="value ${stats.profitFactor >= 1 ? 'positive' : 'negative'}">${stats.profitFactor === null || stats.profitFactor === Infinity ? '‚àû' : stats.profitFactor.toFixed(2)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="label">Max Drawdown</div>
                            <div class="value ${(stats.maxDrawdownPercent ?? 0) < 20 ? 'positive' : 'negative'}">-${stats.maxDrawdownPercent?.toFixed(1) ?? '0'}%</div>
                        </div>
                    </div>
                    
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="label">Trades</div>
                            <div class="value">${stats.totalTrades}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">Wins</div>
                            <div class="value">${stats.winningTrades}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">Losses</div>
                            <div class="value">${stats.losingTrades}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">Avg Win</div>
                            <div class="value">${formatCurrency(stats.avgWinUsd)}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">Avg Loss</div>
                            <div class="value">${formatCurrency(stats.avgLossUsd)}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">Avg Hold</div>
                            <div class="value">${formatDuration(stats.avgHoldingTimeMs)}</div>
                        </div>
                    </div>
                    
                    <div class="capital-progress">
                        <span class="start">Capital: ${formatCurrency(stats.startingCapital)}</span>
                        <span class="arrow">‚Üí</span>
                        <span class="current">${formatCurrency(stats.currentCapital)}</span>
                    </div>
                </div>
            `;
        }
        
        // Render open position card
        function renderPositionCard(pos) {
            const isProfit = (pos.unrealizedPnl || 0) >= 0;
            const pnlClass = isProfit ? 'profit' : 'loss';
            const pnlValueClass = isProfit ? 'positive' : 'negative';
            
            return `
                <div class="position-card ${pnlClass}">
                    <div class="position-header">
                        <div>
                            <div class="position-asset">${pos.asset}</div>
                            <div class="position-meta">
                                <span class="tag ${pos.direction.toLowerCase()}">${pos.direction} ${pos.leverage}x</span>
                                <span class="tag ${pos.strategy === 'V5.0' || pos.strategy === 'v5.0' || pos.strategy === 'v5.1' ? 'v5' : pos.strategy === 'IBB' ? 'ibb' : 'defi'}">${pos.strategy}</span>
                            </div>
                        </div>
                        <div class="position-pnl">
                            <div class="value ${pnlValueClass}">${formatCurrency(pos.unrealizedPnl)}</div>
                            <div class="pct">${formatPercent(pos.unrealizedPnlPct)}</div>
                        </div>
                    </div>
                    <div class="position-details">
                        <div class="position-detail">
                            <div class="label">Entry</div>
                            <div class="value">$${pos.entryPrice?.toLocaleString()}</div>
                        </div>
                        <div class="position-detail">
                            <div class="label">Current</div>
                            <div class="value">$${pos.currentPrice?.toLocaleString()}</div>
                        </div>
                        <div class="position-detail">
                            <div class="label">Stop Loss</div>
                            <div class="value sl">$${pos.stopLoss?.toLocaleString() || '-'}</div>
                        </div>
                        <div class="position-detail">
                            <div class="label">Take Profit</div>
                            <div class="value tp">$${pos.takeProfit?.toLocaleString() || '-'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Render trade row
        function renderTradeRow(trade) {
            const isOpen = trade.status === 'OPEN';
            const isWin = (trade.pnlUsd || 0) > 0;
            
            return `
                <tr>
                    <td><span class="tag ${trade.strategy === 'V5.0' || trade.strategy === 'v5.0' || trade.strategy === 'v5.1' ? 'v5' : trade.strategy === 'IBB' ? 'ibb' : trade.strategy === 'BRT' ? 'brt' : 'defi'}">${trade.strategy}</span></td>
                    <td class="asset-cell">
                        <div class="name">${trade.asset}</div>
                        <div class="exchange">${trade.exchange}</div>
                    </td>
                    <td><span class="tag ${trade.direction.toLowerCase()}">${trade.direction} ${trade.leverage}x</span></td>
                    <td class="price-cell">
                        <div class="price">$${trade.entryPrice.toLocaleString()}</div>
                        <div class="time">${formatDate(trade.entryTime)}</div>
                    </td>
                    <td class="price-cell">
                        ${isOpen ? '<span class="tag open">Open</span>' : `
                            <div class="price">$${trade.exitPrice?.toLocaleString()}</div>
                            <div class="time">${trade.exitReason}</div>
                        `}
                    </td>
                    <td>${formatCurrency(trade.positionSize)}</td>
                    <td class="pnl-cell">
                        ${isOpen ? '-' : `
                            <div class="usd ${isWin ? 'positive' : 'negative'}">${formatCurrency(trade.pnlUsd)}</div>
                            <div class="pct ${isWin ? 'positive' : 'negative'}">${formatPercent(trade.pnlPercent)}</div>
                        `}
                    </td>
                </tr>
            `;
        }
        
        // Load and render data
        async function loadData() {
            try {
                const cacheBust = Date.now();
                const [statsRes, tradesRes, positionsRes] = await Promise.all([
                    fetch(`trading-stats.json?v=${cacheBust}`),
                    fetch(`trading-trades.json?v=${cacheBust}`),
                    fetch(`open-positions.json?v=${cacheBust}`)
                ]);
                
                if (!statsRes.ok) throw new Error('Stats fetch failed: ' + statsRes.status);
                if (!tradesRes.ok) throw new Error('Trades fetch failed: ' + tradesRes.status);
                
                const stats = await statsRes.json();
                const trades = await tradesRes.json();
                
                // Handle open positions (may not exist yet)
                let openPositions = [];
                if (positionsRes.ok) {
                    openPositions = await positionsRes.json();
                }
                
                // Render open positions
                renderOpenPositions(openPositions);
                
                // Render strategy cards
                const grid = document.getElementById('strategiesGrid');
                grid.innerHTML = stats.map(s => renderStrategyCard(s)).join('');
                
                // Filter out open trades from history (only show closed)
                const closedTrades = trades.filter(t => t.status !== 'OPEN');
                
                // Render trade table
                const tbody = document.getElementById('tradeTableBody');
                if (closedTrades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No trades logged yet</td></tr>';
                } else {
                    tbody.innerHTML = closedTrades.map(t => renderTradeRow(t)).join('');
                }
                
                // Update counts and timestamp
                document.getElementById('tradeCount').textContent = `${closedTrades.length} closed trades ‚Ä¢ Most recent first`;
                document.getElementById('lastUpdated').textContent = `Updated ${new Date().toLocaleString()}`;
                
            } catch (err) {
                console.error('Failed to load data:', err);
                document.getElementById('strategiesGrid').innerHTML = '<div class="empty-state">Failed to load trading data</div>';
            }
        }
        
        // Render open positions
        function renderOpenPositions(positions) {
            const panel = document.getElementById('openPositions');
            const countBadge = document.getElementById('positionCount');
            const grid = document.getElementById('positionsGrid');
            
            if (!positions || positions.length === 0) {
                panel.className = 'open-positions no-positions';
                countBadge.className = 'position-count none';
                countBadge.textContent = 'No Open Positions';
                grid.innerHTML = '<div class="no-positions-msg">All flat ‚Äî watching for signals...</div>';
                return;
            }
            
            panel.className = 'open-positions';
            countBadge.className = 'position-count';
            countBadge.textContent = `${positions.length} Position${positions.length > 1 ? 's' : ''} Open`;
            grid.innerHTML = positions.map(p => renderPositionCard(p)).join('');
        }
        
        // Load watchdog status
        async function loadWatchdogStatus() {
            try {
                const cacheBust = Date.now();
                const res = await fetch(`watchdog-status.json?v=${cacheBust}`);
                
                if (!res.ok) {
                    renderWatchdogError('Status file not found');
                    return;
                }
                
                const status = await res.json();
                renderWatchdogStatus(status);
                
            } catch (err) {
                console.error('Failed to load watchdog status:', err);
                renderWatchdogError('Failed to load');
            }
        }
        
        function renderWatchdogError(message) {
            const panel = document.getElementById('systemsStatus');
            const badge = document.getElementById('systemsBadge');
            const grid = document.getElementById('systemsGrid');
            const executions = document.getElementById('lastExecutions');
            
            panel.className = 'systems-status warning';
            badge.className = 'status-badge warning';
            badge.textContent = 'Unknown';
            grid.innerHTML = `<div class="system-check"><span class="indicator warn"></span><span class="name">${message}</span></div>`;
            executions.innerHTML = '';
        }
        
        function renderWatchdogStatus(status) {
            const panel = document.getElementById('systemsStatus');
            const badge = document.getElementById('systemsBadge');
            const grid = document.getElementById('systemsGrid');
            const executions = document.getElementById('lastExecutions');
            
            // Determine overall status
            let overallStatus = 'healthy';
            let badgeText = 'All Systems Go';
            
            if (status.issueCount > 0) {
                overallStatus = 'error';
                badgeText = `${status.issueCount} Issue${status.issueCount > 1 ? 's' : ''}`;
            } else if (status.warningCount > 0) {
                overallStatus = 'warning';
                badgeText = `${status.warningCount} Warning${status.warningCount > 1 ? 's' : ''}`;
            }
            
            // Check if status is stale (>1 hour old)
            const ageMs = Date.now() - status.timestamp;
            const ageHours = ageMs / (1000 * 60 * 60);
            if (ageHours > 1) {
                overallStatus = 'warning';
                badgeText = `Stale (${ageHours.toFixed(1)}h ago)`;
            }
            
            panel.className = `systems-status ${overallStatus}`;
            badge.className = `status-badge ${overallStatus}`;
            badge.textContent = badgeText;
            
            // Render checks
            grid.innerHTML = status.checks.map(check => {
                const indicatorClass = check.status === 'ok' ? 'ok' : check.status === 'warn' ? 'warn' : 'error';
                return `
                    <div class="system-check">
                        <span class="indicator ${indicatorClass}"></span>
                        <span class="name">${check.name}</span>
                        <span class="detail">${check.message.substring(0, 30)}</span>
                    </div>
                `;
            }).join('');
            
            // Render last executions
            const exec = status.executions;
            let execHtml = '';
            
            if (exec.v5) {
                const isStale = parseFloat(exec.v5.hoursAgo) > 2;
                execHtml += `
                    <div class="execution-item">
                        <span class="label">V5.0:</span>
                        <span class="time ${isStale ? 'stale' : ''}">${exec.v5.hoursAgo}h ago</span>
                    </div>
                `;
            }
            if (exec.ibb) {
                const isStale = parseFloat(exec.ibb.hoursAgo) > 2;
                execHtml += `
                    <div class="execution-item">
                        <span class="label">IBB:</span>
                        <span class="time ${isStale ? 'stale' : ''}">${exec.ibb.hoursAgo}h ago</span>
                    </div>
                `;
            }
            if (exec.brt) {
                const isStale = parseFloat(exec.brt.hoursAgo) > 2;
                execHtml += `
                    <div class="execution-item">
                        <span class="label">BRT:</span>
                        <span class="time ${isStale ? 'stale' : ''}">${exec.brt.hoursAgo}h ago</span>
                    </div>
                `;
            }
            if (exec.drift) {
                const isStale = parseFloat(exec.drift.hoursAgo) > 2;
                execHtml += `
                    <div class="execution-item">
                        <span class="label">Drift:</span>
                        <span class="time ${isStale ? 'stale' : ''}">${exec.drift.hoursAgo}h ago</span>
                    </div>
                `;
            }
            
            execHtml += `
                <div class="execution-item" style="margin-left: auto;">
                    <span class="label">Last Check:</span>
                    <span class="time">${new Date(status.timestamp).toLocaleTimeString()}</span>
                </div>
            `;
            
            executions.innerHTML = execHtml;
        }
        
        // Initial load
        loadData();
        loadWatchdogStatus();
        
        // Auto-refresh every 5 minutes
        setInterval(loadData, 300000);
        setInterval(loadWatchdogStatus, 60000); // Watchdog status every minute
    </script>
</body>
</html>
