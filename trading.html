<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Performance | Jarvis</title>
    <meta http-equiv="refresh" content="300">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: linear-gradient(135deg, #1a1a2e 0%, #16162a 100%);
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --accent-green: #00ff88;
            --accent-green-dim: rgba(0,255,136,0.15);
            --accent-red: #ff4757;
            --accent-red-dim: rgba(255,71,87,0.15);
            --accent-blue: #58a6ff;
            --accent-purple: #a855f7;
            --border-color: #2a2a4a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 24px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header .subtitle { color: var(--text-secondary); margin-top: 4px; }
        .header .updated {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        /* Strategy Cards Grid */
        .strategies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        /* Strategy Card */
        .strategy-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
        }
        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .strategy-name {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .strategy-since {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .total-return {
            text-align: right;
        }
        .total-return .value {
            font-size: 2rem;
            font-weight: 700;
        }
        .total-return .value.positive { color: var(--accent-green); }
        .total-return .value.negative { color: var(--accent-red); }
        .total-return .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 12px;
        }
        .metric-card .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .metric-card .value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .metric-card .value.positive { color: var(--accent-green); }
        .metric-card .value.negative { color: var(--accent-red); }
        
        /* Mini Stats */
        .mini-stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            text-align: center;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        .mini-stat .label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .mini-stat .value {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Capital Progress */
        .capital-progress {
            display: flex;
            justify-content: space-between;
            padding-top: 16px;
            margin-top: 16px;
            border-top: 1px solid var(--border-color);
            font-size: 0.875rem;
        }
        .capital-progress .start { color: var(--text-secondary); }
        .capital-progress .arrow { color: var(--text-secondary); }
        .capital-progress .current { font-weight: 600; }
        
        /* Trade Log */
        .trade-log {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
        }
        .trade-log-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .trade-log-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .trade-log-header .count {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        /* Table */
        .trade-table {
            width: 100%;
            border-collapse: collapse;
        }
        .trade-table th {
            background: rgba(0,0,0,0.3);
            padding: 12px 16px;
            text-align: left;
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trade-table th:last-child { text-align: right; }
        .trade-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }
        .trade-table tr:hover { background: rgba(255,255,255,0.02); }
        
        /* Tags */
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        .tag.v5 { background: rgba(88,166,255,0.2); color: var(--accent-blue); }
        .tag.kraken { background: rgba(88,166,255,0.2); color: var(--accent-blue); }
        .tag.drift { background: rgba(168,85,247,0.2); color: var(--accent-purple); }
        .tag.long { background: var(--accent-green-dim); color: var(--accent-green); }
        .tag.short { background: var(--accent-red-dim); color: var(--accent-red); }
        .tag.open { background: rgba(255,165,2,0.2); color: #ffa502; }
        
        /* P&L Cell */
        .pnl-cell { text-align: right; }
        .pnl-cell .usd { font-weight: 600; }
        .pnl-cell .usd.positive { color: var(--accent-green); }
        .pnl-cell .usd.negative { color: var(--accent-red); }
        .pnl-cell .pct { font-size: 0.75rem; }
        .pnl-cell .pct.positive { color: rgba(0,255,136,0.7); }
        .pnl-cell .pct.negative { color: rgba(255,71,87,0.7); }
        
        /* Asset Cell */
        .asset-cell .name { font-weight: 500; }
        .asset-cell .exchange { font-size: 0.7rem; color: var(--text-secondary); }
        
        /* Entry/Exit Cell */
        .price-cell .price { }
        .price-cell .time { font-size: 0.7rem; color: var(--text-secondary); }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px;
            color: var(--text-secondary);
        }
        
        /* Systems Status Panel */
        .systems-status {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }
        .systems-status.healthy { border-color: rgba(0,255,136,0.3); }
        .systems-status.warning { border-color: rgba(255,165,2,0.3); }
        .systems-status.error { border-color: rgba(255,71,87,0.3); }
        
        .systems-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .systems-header h2 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .systems-header .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-badge.healthy { background: var(--accent-green-dim); color: var(--accent-green); }
        .status-badge.warning { background: rgba(255,165,2,0.2); color: #ffa502; }
        .status-badge.error { background: var(--accent-red-dim); color: var(--accent-red); }
        
        .systems-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .system-check {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            font-size: 0.85rem;
        }
        .system-check .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .system-check .indicator.ok { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
        .system-check .indicator.warn { background: #ffa502; box-shadow: 0 0 8px #ffa502; }
        .system-check .indicator.error { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }
        .system-check .name { flex: 1; }
        .system-check .detail { color: var(--text-secondary); font-size: 0.75rem; }
        
        .last-executions {
            display: flex;
            gap: 24px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            font-size: 0.8rem;
        }
        .execution-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .execution-item .label { color: var(--text-secondary); }
        .execution-item .time { font-weight: 500; }
        .execution-item .time.stale { color: var(--accent-red); }
        
        /* Open Positions Panel */
        .open-positions {
            background: linear-gradient(135deg, #1a2a1a 0%, #162a16 100%);
            border: 2px solid rgba(0,255,136,0.3);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }
        .open-positions.no-positions {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }
        .open-positions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .open-positions-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .position-count {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--accent-green-dim);
            color: var(--accent-green);
        }
        .position-count.none {
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
        }
        .positions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 16px;
        }
        .position-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
        }
        .position-card.profit { border-left: 3px solid var(--accent-green); }
        .position-card.loss { border-left: 3px solid var(--accent-red); }
        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .position-asset {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .position-exchange {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        .strategy-tag {
            font-weight: 600;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }
        .strategy-tag.v50 {
            background: rgba(88, 166, 255, 0.2);
            color: var(--accent-blue);
        }
        .strategy-tag.ibb {
            background: rgba(168, 85, 247, 0.2);
            color: var(--accent-purple);
        }
        .strategy-tag.lc {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }
        .strategy-tag.vwap {
            background: rgba(88, 166, 255, 0.15); color: #58a6ff; border-color: rgba(88, 166, 255, 0.3);
        }
        .strategy-tag.momentum {
            background: rgba(255, 165, 2, 0.2);
            color: #ffa502;
        }
        .position-meta {
            display: flex;
            gap: 8px;
            margin-top: 4px;
            align-items: center;
        }
        .entry-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: auto;
        }
        .position-pnl {
            text-align: right;
        }
        .position-pnl .value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .position-pnl .value.positive { color: var(--accent-green); }
        .position-pnl .value.negative { color: var(--accent-red); }
        .position-pnl .pct {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .position-details {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        .position-detail .label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .position-detail .value {
            font-size: 0.9rem;
            font-weight: 500;
        }
        .position-detail .value.sl { color: var(--accent-red); }
        .position-detail .value.tp { color: var(--accent-green); }
        .no-positions-msg {
            text-align: center;
            padding: 24px;
            color: var(--text-secondary);
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 24px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .strategies-grid { grid-template-columns: 1fr; }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .mini-stats { grid-template-columns: repeat(3, 1fr); }
            .trade-table { font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>MegaMax Trading Performance</h1>
                <p class="subtitle">V5.0 + IBB + Momentum + LC + VWAP Scalper on Drift Protocol â€¢ Live trading â€¢ MegaMax v1.7</p>
            </div>
            <div class="updated" id="lastUpdated">Loading...</div>
        </div>
        
        <!-- Open Positions Panel -->
        <div class="open-positions" id="openPositions">
            <div class="open-positions-header">
                <h2>ðŸ“Š Open Positions</h2>
                <span class="position-count" id="positionCount">Loading...</span>
            </div>
            <div class="positions-grid" id="positionsGrid">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <!-- System Overview Panel -->
        <div class="systems-status healthy" id="systemsStatus">
            <div class="systems-header">
                <h2>âš¡ MegaMax Drift Trading System</h2>
                <span class="status-badge healthy" id="systemsBadge">LIVE</span>
            </div>
            <div class="systems-grid" id="systemsGrid">
                <div class="system-check">
                    <span class="indicator ok"></span>
                    <span class="name">V5.0 Mean Reversion</span>
                    <span class="detail">SOL, LTC, INJ, PEPE, RNDR â€¢ Fade breakouts</span>
                </div>
                <div class="system-check">
                    <span class="indicator ok"></span>
                    <span class="name">IBB Inside Bar</span>
                    <span class="detail">DOT, XRP, DOGE, ETH â€¢ Breakout signals</span>
                </div>
                <div class="system-check">
                    <span class="indicator ok"></span>
                    <span class="name">ðŸš€ Momentum</span>
                    <span class="detail">BONK, ARB, SUI, WIF, W, RNDR â€¢ Daily breakouts</span>
                </div>
                <div class="system-check">
                    <span class="indicator ok"></span>
                    <span class="name">ðŸ“‰ LC (RSI)</span>
                    <span class="detail">RNDR, NEAR, JUP, SOL, DOGE, PYTH, OP â€¢ RSI(2) mean reversion</span>
                </div>
                <div class="system-check">
                    <span class="indicator ok"></span>
                    <span class="name">âš¡ VWAP Scalper</span>
                    <span class="detail">SOL â€¢ 30s VWAP band reversion â€¢ $50/trade</span>
                </div>
            </div>
            <div class="last-executions" id="lastExecutions">
                <div class="execution-item">
                    <span class="label">Last Check:</span>
                    <span class="time" id="lastCheckTime">-</span>
                </div>
                <div class="execution-item">
                    <span class="label">Account:</span>
                    <span class="time" id="accountBalance">$1,880</span>
                </div>
                <div class="execution-item">
                    <span class="label">Cron:</span>
                    <span class="time">Hourly @:05</span>
                </div>
            </div>
        </div>
        
        <!-- Strategy Cards -->
        <div class="strategies-grid" id="strategiesGrid">
            <!-- Populated by JS -->
        </div>
        
        <!-- Trade Log -->
        <div class="trade-log">
            <div class="trade-log-header">
                <h2>Trade History</h2>
                <p class="count" id="tradeCount">Loading...</p>
            </div>
            <table class="trade-table">
                <thead>
                    <tr>
                        <th>Strategy</th>
                        <th>Asset</th>
                        <th>Direction</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>Size</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="tradeTableBody">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            Auto-updated every 5 minutes â€¢ Trades execute with automatic stop-loss protection
        </div>
    </div>

    <script>
        // ============================================================
        // MegaMax Dashboard v2.0 - Robust Data Loading
        // Loads: state.json (positions/trades) + trading-stats.json (strategy stats)
        // ============================================================
        
        // Utility functions with safe defaults
        function formatCurrency(value) {
            if (value === undefined || value === null || typeof value !== 'number' || isNaN(value)) return '$-';
            const abs = Math.abs(value);
            const formatted = abs >= 1000 ? `$${(abs/1000).toFixed(1)}k` : `$${abs.toFixed(2)}`;
            return value < 0 ? `-${formatted}` : formatted;
        }
        
        function formatPercent(value) {
            if (value === undefined || value === null || typeof value !== 'number' || isNaN(value)) return '-';
            return `${value >= 0 ? '+' : ''}${value.toFixed(2)}%`;
        }
        
        function formatDuration(ms) {
            if (!ms || typeof ms !== 'number' || isNaN(ms)) return '-';
            const hours = ms / (1000 * 60 * 60);
            return hours < 24 ? `${hours.toFixed(1)}h` : `${(hours/24).toFixed(1)}d`;
        }
        
        function formatDate(ts) {
            if (!ts) return '-';
            try {
                const d = new Date(ts);
                if (isNaN(d.getTime())) return '-';
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            } catch { return '-'; }
        }
        
        function formatDateShort(ts) {
            if (!ts) return 'N/A';
            try {
                const d = new Date(ts);
                if (isNaN(d.getTime())) return 'N/A';
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch { return 'N/A'; }
        }
        
        function safeNum(val, fallback = 0) {
            return (typeof val === 'number' && !isNaN(val)) ? val : fallback;
        }
        
        // Render strategy card with safe defaults
        function renderStrategyCard(stats) {
            const pnl = safeNum(stats.totalPnlUsd);
            const isProfit = pnl >= 0;
            const winRate = safeNum(stats.winRate);
            const pf = stats.profitFactor;
            const pfDisplay = (!pf || pf === Infinity || pf > 100) ? 'âˆž' : safeNum(pf).toFixed(2);
            
            return `
                <div class="strategy-card">
                    <div class="strategy-header">
                        <div>
                            <div class="strategy-name">${stats.strategy || 'Unknown'} Strategy</div>
                            <div class="strategy-since">Since ${formatDateShort(stats.firstTradeTime)}</div>
                        </div>
                        <div class="total-return">
                            <div class="value ${isProfit ? 'positive' : 'negative'}">${formatPercent(stats.totalPnlPercent)}</div>
                            <div class="label">Total Return</div>
                        </div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="label">Total P&L</div>
                            <div class="value ${isProfit ? 'positive' : 'negative'}">${formatCurrency(pnl)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="label">Win Rate</div>
                            <div class="value ${winRate >= 50 ? 'positive' : 'negative'}">${winRate.toFixed(1)}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="label">Profit Factor</div>
                            <div class="value ${safeNum(pf, 1) >= 1 ? 'positive' : 'negative'}">${pfDisplay}</div>
                        </div>
                        <div class="metric-card">
                            <div class="label">Max Drawdown</div>
                            <div class="value ${safeNum(stats.maxDrawdownPercent) < 20 ? 'positive' : 'negative'}">-${safeNum(stats.maxDrawdownPercent).toFixed(1)}%</div>
                        </div>
                    </div>
                    
                    <div class="mini-stats">
                        <div class="mini-stat">
                            <div class="label">Trades</div>
                            <div class="value">${safeNum(stats.totalTrades)}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">Wins</div>
                            <div class="value">${safeNum(stats.winningTrades)}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">Losses</div>
                            <div class="value">${safeNum(stats.losingTrades)}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">Avg Win</div>
                            <div class="value">${formatCurrency(stats.avgWinUsd)}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">Avg Loss</div>
                            <div class="value">${formatCurrency(stats.avgLossUsd)}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="label">Avg Hold</div>
                            <div class="value">${formatDuration(stats.avgHoldingTimeMs)}</div>
                        </div>
                    </div>
                    
                    <div class="capital-progress">
                        <span class="start">Capital: ${formatCurrency(stats.startingCapital)}</span>
                        <span class="arrow">â†’</span>
                        <span class="current">${formatCurrency(stats.currentCapital)}</span>
                    </div>
                </div>
            `;
        }
        
        // Render open position card
        function renderPositionCard(pos) {
            const pnl = safeNum(pos.unrealizedPnl);
            const isProfit = pnl >= 0;
            const pnlClass = isProfit ? 'profit' : 'loss';
            const pnlValueClass = isProfit ? 'positive' : 'negative';
            const strategy = pos.strategy || 'V5.0';
            const strategyClass = strategy === 'IBB' ? 'ibb' : strategy === 'LC' ? 'lc' : strategy === 'MOMENTUM' ? 'momentum' : strategy === 'VWAP-RSI' ? 'vwap' : 'v50';
            const leverage = safeNum(pos.leverage, 5);
            const direction = pos.direction || 'LONG';
            
            return `
                <div class="position-card ${pnlClass}">
                    <div class="position-header">
                        <div>
                            <div class="position-asset">${pos.asset || 'Unknown'}</div>
                            <div class="position-exchange">${pos.exchange || 'Drift'} â€¢ <span class="strategy-tag ${strategyClass}">${strategy}</span></div>
                            <div class="position-meta">
                                <span class="tag ${direction.toLowerCase()}">${direction} ${leverage}x</span>
                                <span class="entry-date">${formatDate(pos.entryTime)}</span>
                            </div>
                        </div>
                        <div class="position-pnl">
                            <div class="value ${pnlValueClass}">${formatCurrency(pnl)}</div>
                            <div class="pct">${formatPercent(pos.unrealizedPnlPct)}</div>
                        </div>
                    </div>
                    <div class="position-details">
                        <div class="position-detail">
                            <div class="label">Size</div>
                            <div class="value">${formatCurrency(pos.positionSize)}</div>
                        </div>
                        <div class="position-detail">
                            <div class="label">Entry</div>
                            <div class="value">$${safeNum(pos.entryPrice).toLocaleString()}</div>
                        </div>
                        <div class="position-detail">
                            <div class="label">Current</div>
                            <div class="value">$${safeNum(pos.currentPrice).toLocaleString()}</div>
                        </div>
                        <div class="position-detail">
                            <div class="label">Stop Loss</div>
                            <div class="value sl">${pos.stopLoss ? '$' + pos.stopLoss.toLocaleString() : '$-'}</div>
                        </div>
                        <div class="position-detail">
                            <div class="label">Take Profit</div>
                            <div class="value tp">${pos.takeProfit ? '$' + pos.takeProfit.toLocaleString() : '$-'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Render trade row
        function renderTradeRow(trade) {
            const isOpen = trade.status === 'OPEN';
            const pnl = safeNum(trade.pnlUsd || trade.pnl);
            const isWin = pnl > 0 || trade.result === 'WIN';
            const strategy = trade.strategy || 'V5.0';
            const direction = trade.direction || 'LONG';
            const leverage = safeNum(trade.leverage, 5);
            
            return `
                <tr>
                    <td><span class="tag drift">${strategy}</span></td>
                    <td class="asset-cell">
                        <div class="name">${trade.asset || 'Unknown'}</div>
                        <div class="exchange">${trade.exchange || 'Drift'}</div>
                    </td>
                    <td><span class="tag ${direction.toLowerCase()}">${direction} ${leverage}x</span></td>
                    <td class="price-cell">
                        <div class="price">$${safeNum(trade.entryPrice).toLocaleString()}</div>
                        <div class="time">${formatDate(trade.entryTime)}</div>
                    </td>
                    <td class="price-cell">
                        ${isOpen ? '<span class="tag open">Open</span>' : `
                            <div class="price">$${safeNum(trade.exitPrice).toLocaleString()}</div>
                            <div class="time">${trade.exitReason || 'Closed'}</div>
                        `}
                    </td>
                    <td>${formatCurrency(trade.positionSize)}</td>
                    <td class="pnl-cell">
                        ${isOpen ? '-' : `
                            <div class="usd ${isWin ? 'positive' : 'negative'}">${formatCurrency(pnl)}</div>
                            <div class="pct ${isWin ? 'positive' : 'negative'}">${formatPercent(trade.pnlPercent)}</div>
                        `}
                    </td>
                </tr>
            `;
        }
        
        // Main data loader - fetches both state.json and trading-stats.json
        async function loadData() {
            const cacheBust = Date.now();
            let state = null;
            let strategyStats = [];
            let errors = [];
            
            // Fetch state.json (positions + trades)
            try {
                const stateRes = await fetch(`state.json?v=${cacheBust}`);
                if (stateRes.ok) {
                    state = await stateRes.json();
                } else {
                    errors.push(`state.json: ${stateRes.status}`);
                }
            } catch (e) {
                errors.push(`state.json: ${e.message}`);
            }
            
            // Fetch trading-stats.json (strategy performance)
            try {
                const statsRes = await fetch(`trading-stats.json?v=${cacheBust}`);
                if (statsRes.ok) {
                    strategyStats = await statsRes.json();
                }
            } catch (e) {
                // Stats file optional - compute from trades if missing
            }
            
            // Fetch trade history â€” prefer trade-log.json (source of truth), fall back to trading-trades.json
            let tradeHistoryData = [];
            try {
                const logRes = await fetch(`trade-log.json?v=${cacheBust}`);
                if (logRes.ok) {
                    const logData = await logRes.json();
                    const allLogTrades = logData.trades || logData;
                    // Convert trade-log format to dashboard format (only closed trades)
                    tradeHistoryData = allLogTrades.filter(t => t.status === 'CLOSED').map(t => ({
                        id: t.id,
                        asset: t.symbol,
                        strategy: t.strategy,
                        direction: t.direction,
                        status: 'CLOSED',
                        entryPrice: t.entry?.price,
                        exitPrice: t.exit?.price,
                        entryTime: t.entry?.time || t.timestamp,
                        exitTime: t.exit?.time,
                        leverage: t.leverage || 5,
                        positionSize: t.positionSize || 200,
                        pnl: t.pnl?.netPnl ?? 0,
                        pnlPercent: t.pnl?.pnlPercent ?? 0,
                        result: (t.pnl?.netPnl ?? 0) > 0 ? 'WIN' : 'LOSS'
                    }));
                    console.log(`Loaded ${tradeHistoryData.length} trades from trade-log.json`);
                }
            } catch (e) {
                console.log('trade-log.json failed, trying trading-trades.json');
            }
            // Fallback to trading-trades.json
            if (tradeHistoryData.length === 0) {
                try {
                    const tradesRes = await fetch(`trading-trades.json?v=${cacheBust}`);
                    if (tradesRes.ok) {
                        tradeHistoryData = await tradesRes.json();
                    }
                } catch (e) { }
            }
            
            // If state.json failed completely, show error
            if (!state) {
                document.getElementById('lastUpdated').textContent = 'Error loading data';
                document.getElementById('lastUpdated').style.color = '#ff4757';
                document.getElementById('positionCount').textContent = 'Error';
                document.getElementById('tradeCount').textContent = errors.join(', ');
                return;
            }
            
            // === RENDER OPEN POSITIONS ===
            const openPositions = (state.openPositions || []).map(p => ({
                asset: p.symbol || p.asset,
                exchange: p.exchange || 'Drift',  // Use actual exchange from data
                strategy: p.strategy || 'V5.0',
                direction: p.direction || 'LONG',
                leverage: p.leverage || 5,
                entryPrice: p.entry || p.entryPrice,
                currentPrice: p.current || p.currentPrice,
                stopLoss: p.stop || p.stopLoss || null,
                takeProfit: p.target || p.takeProfit || null,
                positionSize: p.size || p.positionSize,
                unrealizedPnl: p.pnl || p.unrealizedPnl,
                unrealizedPnlPct: p.pnlPercent || p.unrealizedPnlPct,
                entryTime: p.entryTime || state.lastUpdate
            }));
            renderOpenPositions(openPositions);
            
            // === RENDER STRATEGY CARDS ===
            // Use trading-stats.json if available, otherwise create defaults
            const defaultStrategies = ['V5.0', 'IBB', 'LC', 'MOMENTUM', 'VWAP-RSI'];
            const statsMap = {};
            
            // Initialize with defaults
            defaultStrategies.forEach(s => {
                statsMap[s] = {
                    strategy: s,
                    totalTrades: 0,
                    winningTrades: 0,
                    losingTrades: 0,
                    winRate: 0,
                    totalPnlUsd: 0,
                    totalPnlPercent: 0,
                    avgWinUsd: 0,
                    avgLossUsd: 0,
                    profitFactor: 0,
                    maxDrawdownPercent: 0,
                    avgHoldingTimeMs: 0,
                    startingCapital: state.account?.startingEquity || 1868.46,
                    currentCapital: state.account?.equity || 2076,
                    firstTradeTime: null
                };
            });
            
            // Merge loaded stats
            strategyStats.forEach(s => {
                if (s.strategy) {
                    statsMap[s.strategy] = { ...statsMap[s.strategy], ...s };
                }
            });
            
            // Compute stats from trades if stats file is empty/missing
            const allTrades = state.recentTrades || [];
            if (allTrades.length > 0) {
                allTrades.forEach(t => {
                    const strat = t.strategy || 'V5.0';
                    if (!statsMap[strat]) {
                        statsMap[strat] = { ...statsMap['V5.0'], strategy: strat };
                    }
                    if (t.status === 'CLOSED') {
                        statsMap[strat].totalTrades++;
                        const pnl = t.pnl || 0;
                        statsMap[strat].totalPnlUsd += pnl;
                        if (pnl > 0) statsMap[strat].winningTrades++;
                        else statsMap[strat].losingTrades++;
                        
                        if (!statsMap[strat].firstTradeTime || new Date(t.entryTime) < new Date(statsMap[strat].firstTradeTime)) {
                            statsMap[strat].firstTradeTime = t.entryTime;
                        }
                    }
                });
                
                // Calculate derived stats
                Object.values(statsMap).forEach(s => {
                    if (s.totalTrades > 0) {
                        s.winRate = (s.winningTrades / s.totalTrades) * 100;
                        s.totalPnlPercent = (s.totalPnlUsd / s.startingCapital) * 100;
                    }
                });
            }
            
            // Render only strategies with trades or that are active
            const activeStrategies = Object.values(statsMap).filter(s => 
                s.totalTrades > 0 || ['V5.0', 'IBB', 'LC', 'MOMENTUM', 'VWAP-RSI', 'LC-Kraken'].includes(s.strategy)
            );
            
            const grid = document.getElementById('strategiesGrid');
            grid.innerHTML = activeStrategies.map(s => renderStrategyCard(s)).join('');
            
            // === RENDER TRADE HISTORY ===
            // Combine trades from state.recentTrades + trade history
            // tradeHistoryData is already normalized (from trade-log.json or trading-trades.json)
            // allTrades from state.recentTrades needs normalization
            const normalizedStateRecent = allTrades
                .filter(t => t.status === 'CLOSED' || (!t.status && t.exit))
                .map(t => {
                    // Handle pnl being either a number or an object {netPnl, pnlPercent}
                    const pnlVal = typeof t.pnl === 'object' ? (t.pnl?.netPnl ?? 0) : (t.pnl || 0);
                    const pnlPct = typeof t.pnl === 'object' ? (t.pnl?.pnlPercent ?? 0) : (t.pnlPercent || 0);
                    return {
                        strategy: t.strategy || 'V5.0',
                        asset: t.symbol || t.asset,
                        exchange: t.exchange || 'Drift',
                        direction: t.direction || 'LONG',
                        leverage: t.leverage || 5,
                        entryPrice: typeof t.entry === 'object' ? t.entry?.price : (t.entry || t.entryPrice),
                        exitPrice: typeof t.exit === 'object' ? t.exit?.price : (t.exit || t.exitPrice),
                        entryTime: t.entryTime || t.entry?.time || t.timestamp,
                        exitTime: t.exitTime || t.exit?.time,
                        exitReason: t.exitReason || (pnlVal > 0 ? 'TP' : 'SL'),
                        positionSize: t.size || t.positionSize || 375,
                        pnl: pnlVal,
                        pnlPercent: pnlPct,
                        result: t.result || (pnlVal > 0 ? 'WIN' : 'LOSS'),
                        status: t.status || 'CLOSED'
                    };
                });
            
            // Deduplicate by preferring tradeHistoryData (more complete)
            const historyIds = new Set(tradeHistoryData.map(t => t.id));
            const uniqueRecent = normalizedStateRecent.filter(t => !t.id || !historyIds.has(t.id));
            const closedTrades = [...uniqueRecent, ...tradeHistoryData];
            
            const tbody = document.getElementById('tradeTableBody');
            if (closedTrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No closed trades yet</td></tr>';
            } else {
                tbody.innerHTML = closedTrades.map(t => renderTradeRow(t)).join('');
            }
            
            // === UPDATE HEADER INFO ===
            const totalWins = closedTrades.filter(t => t.pnlUsd > 0 || t.result === 'WIN').length;
            const winRate = closedTrades.length > 0 ? Math.round((totalWins / closedTrades.length) * 100) : 0;
            document.getElementById('tradeCount').textContent = `${closedTrades.length} closed trades â€¢ Win rate: ${winRate}%`;
            
            // Update timestamp
            const updateTime = state.lastUpdate ? new Date(state.lastUpdate) : new Date();
            document.getElementById('lastUpdated').textContent = `Updated ${updateTime.toLocaleString()}`;
            document.getElementById('lastUpdated').style.color = '';
            
            // Update account balance display
            const balanceEl = document.getElementById('accountBalance');
            if (balanceEl && state.account?.equity) {
                balanceEl.textContent = `$${state.account.equity.toFixed(0)}`;
            }
            
            const checkTimeEl = document.getElementById('lastCheckTime');
            if (checkTimeEl) {
                checkTimeEl.textContent = updateTime.toLocaleTimeString();
            }
        }
        
        // Render open positions
        function renderOpenPositions(positions) {
            const panel = document.getElementById('openPositions');
            const countBadge = document.getElementById('positionCount');
            const grid = document.getElementById('positionsGrid');
            
            if (!positions || positions.length === 0) {
                panel.className = 'open-positions no-positions';
                countBadge.className = 'position-count none';
                countBadge.textContent = 'No Open Positions';
                grid.innerHTML = '<div class="no-positions-msg">All flat â€” watching for signals...</div>';
                return;
            }
            
            panel.className = 'open-positions';
            countBadge.className = 'position-count';
            countBadge.textContent = `${positions.length} Position${positions.length > 1 ? 's' : ''} Open`;
            grid.innerHTML = positions.map(p => renderPositionCard(p)).join('');
        }
        
        // Initial load
        loadData();
        
        // Auto-refresh every 5 minutes
        setInterval(loadData, 300000);
    </script>
    
    <!-- Drift Account Link -->
    <div class="container" style="margin-top: 32px; margin-bottom: 32px; text-align: center;">
        <a href="https://app.drift.trade/?authority=3gPExFYHC8fqkwwrb6De8n9fwYdbJPBG3XYLstKNNkt7" 
           target="_blank" 
           style="display: inline-block; background: linear-gradient(135deg, #1a1a2e 0%, #16162a 100%); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px 32px; color: var(--accent-blue); text-decoration: none; font-size: 1rem; font-weight: 500;">
            ðŸ“Š View Drift Account â†’ Open Positions & Orders
        </a>
        <div style="margin-top: 8px; color: var(--text-secondary); font-size: 0.75rem;">
            Wallet: 3gPExFYHC8fqkwwrb6De8n9fwYdbJPBG3XYLstKNNkt7
        </div>
    </div>
</body>
</html>
